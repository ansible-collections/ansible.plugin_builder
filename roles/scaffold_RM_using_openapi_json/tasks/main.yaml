- name: Print the args
  debug:
    msg:
      - "{{ module_generator['rm_swagger_json'] }}"
      - "{{ module_generator['api_object_path'] }}"
      - "{{ module_generator['module_name'] }}"
      - "{{ module_generator['module_version'] }}"
      - "{{ module_generator['collection_name'] }}"
      - "{{ module_generator['author'] }}"

- name: Get the CURRENT WORKING DIR
  command: "pwd"
  register: dir

- name: Create temporary build directory
  ansible.builtin.tempfile:
    state: directory
    suffix: build
  register: tmp_directory

- name: print temp tmp_directory
  debug:
    msg: "{{ tmp_directory }}"

- name: EXECUTE the python script
  command: python3 doc_generator.py "{{ module_generator['rm_swagger_json'] }}" "{{ module_generator['api_object_path'] }}" "{{ module_generator['module_name'] }}" "{{ module_generator['module_version'] }}" "{{ module_generator['resource'] }}" "{{ module_generator['collection_org'] }}" "{{ module_generator['collection_name'] }}" "{{ module_generator['unique_key'] }}" "{{ module_generator['author'] }}" "{{ tmp_directory["path"] }}"
  # args:
  #   chdir: "./templates"
  delegate_to: 127.0.0.1
  run_once: true

- name: Create a vars temp directory 
  ansible.builtin.file:
    path: "{{ tmp_directory['path'] }}/vars"
    state: directory
    mode: '0755'

- name: Display multiple file contents
  debug: var=item
  with_file:
    - "{{ tmp_directory['path'] }}/data.yml"
    - "{{ tmp_directory['path'] }}/params.json"
  register: test

- name: Copy the MODULE DOC
  copy: content="{{ test['results'][0]['item'] }}" dest="{{ tmp_directory['path'] }}/vars/data.yaml"

- name: Copy the MODULE PARAM DICT
  copy: content="{{ test['results'][1]['item'] }}" dest="{{ tmp_directory['path'] }}/vars/module_params_dict.json"

- name: Extract DOCUMENTATION from source (for new module)
  set_fact:
    rm_documentation: "{{ test['results'][0]['item'] }}"
  when: test is defined

- name: Extract MODULE PARAMS Dict from source (for new module)
  set_fact:
    module_params_dict: "{{ test['results'][1]['item'] }}"
  when: test is defined

- name: get the API object
  set_fact:
    api_object: "api/{{ module_generator['api_object_path'].split('/')[1] | default('default') }}"

- name: Template each of the files
  include: template.yaml
  with_items: "{{ resource_module_templates }}"
  loop_control:
    loop_var: template

- name: Delete TEMP data files
  file:
    path: "{{ item }}"
    state: absent
  with_items:
    - "{{ tmp_directory['path'] }}/vars/data.yaml"
    - "{{ tmp_directory['path'] }}/vars/module_params_dict.json"